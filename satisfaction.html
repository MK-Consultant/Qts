<!DOCTYPE html>
<html data-fr-scheme="system" lang="fr">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="format-detection" content="telephone=no,date=no,address=no,email=no,url=no">
  <meta name="theme-color" content="#000091">
  <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.2/dist/favicon/apple-touch-icon.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.2/dist/favicon/favicon.svg" type="image/svg+xml">
  <link rel="shortcut icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.2/dist/favicon/favicon.ico" type="image/x-icon">
  <title>Formulaire de satisfaction</title>
  
  <!-- DSFR CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.2/dist/utility/utility.min.css">
  
  <style>
    /* Styles personnalis√©s pour l'√©chelle de satisfaction */
    .satisfaction-scale {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.75rem;
      margin: 2rem 0;
    }
    
    .satisfaction-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.25rem 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 120px;
      text-align: center;
      font-family: inherit;
    }
    
    .satisfaction-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #bbb;
    }
    
    .satisfaction-btn.selected {
      border-color: #000091;
      border-width: 3px;
      background-color: #e3e3fd;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,145,0.2);
    }
    
    .satisfaction-btn[data-value="5"] {
      background-color: #e8f5e9;
      color: #1b5e20;
    }
    
    .satisfaction-btn[data-value="5"].selected {
      background-color: #c8e6c9;
    }
    
    .satisfaction-btn[data-value="4"] {
      background-color: #c8e6c9;
      color: #2e7d32;
    }
    
    .satisfaction-btn[data-value="4"].selected {
      background-color: #a5d6a7;
    }
    
    .satisfaction-btn[data-value="3"] {
      background-color: #fff9c4;
      color: #e65100;
    }
    
    .satisfaction-btn[data-value="3"].selected {
      background-color: #fff59d;
    }
    
    .satisfaction-btn[data-value="2"] {
      background-color: #ffccbc;
      color: #e64a19;
    }
    
    .satisfaction-btn[data-value="2"].selected {
      background-color: #ffab91;
    }
    
    .satisfaction-btn[data-value="1"] {
      background-color: #ffcdd2;
      color: #c62828;
    }
    
    .satisfaction-btn[data-value="1"].selected {
      background-color: #ef9a9a;
    }
    
    .satisfaction-emoji {
      font-size: 2rem;
      margin-bottom: 8px;
      line-height: 1;
    }
    
    .satisfaction-label {
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1.3;
    }
    
    /* Barre de progression */
    .step-progress-container {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .step-progress-bar {
      flex: 1;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .step-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #16a34a, #000091);
      transition: width 0.3s ease;
      border-radius: 4px;
    }
    
    .step-text {
      font-size: 0.875rem;
      color: #666;
      white-space: nowrap;
      font-weight: 500;
      min-width: 80px;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Statistiques de synth√®se */
    .synthesis-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin: 2rem 0;
    }
    
    /* Liste des participations */
    .participations-list {
      margin-top: 2rem;
    }
    
    .participation-item {
      border-left: 3px solid #000091;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #f9f9f9;
      border-radius: 4px;
    }
    
    .participation-date {
      font-size: 0.875rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    
    /* Modal de r√©initialisation */
    .reset-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .reset-modal.show {
      display: flex;
    }
    
    .reset-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .secret-reset-link {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.1);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      color: #666;
      opacity: 0.3;
      transition: opacity 0.2s;
      z-index: 999;
    }
    
    .secret-reset-link:hover {
      opacity: 0.6;
    }
    
    .secret-view-link {
      position: fixed;
      bottom: 20px;
      right: 80px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.1);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      color: #666;
      opacity: 0.3;
      transition: opacity 0.2s;
      z-index: 999;
    }
    
    .secret-view-link:hover {
      opacity: 0.6;
    }
    
    /* Modal pour voir tous les retours */
    .view-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      padding: 20px;
    }
    
    .view-modal.show {
      display: flex;
    }
    
    .view-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      margin: auto;
    }
    
    .return-item {
      border-left: 3px solid #000091;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      background: #f9f9f9;
      border-radius: 4px;
    }
    
    .return-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .return-date {
      font-size: 0.875rem;
      color: #666;
      font-weight: 500;
    }
    
    .return-score {
      font-size: 1.25rem;
      color: #000091;
      font-weight: 700;
    }
    
    .return-question-item {
      margin: 0.75rem 0;
      padding: 0.75rem;
      background: white;
      border-radius: 4px;
    }
    
    .return-question-text {
      font-size: 0.875rem;
      color: #333;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .return-answer {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.95rem;
    }
    
    .return-comment {
      margin-top: 1rem;
      padding: 1rem;
      background: #e3f2fd;
      border-left: 3px solid #2196f3;
      border-radius: 4px;
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 0.875rem;
    }
    
    /* Responsive */
    @media (max-width: 991px) {
      .satisfaction-scale {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .satisfaction-scale {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .satisfaction-btn {
        min-height: 80px;
        flex-direction: row;
        justify-content: flex-start;
        text-align: left;
        padding: 1rem;
      }
      
      .satisfaction-emoji {
        margin-right: 15px;
        margin-bottom: 0;
        font-size: 1.5rem;
      }
      
      .synthesis-stats {
        grid-template-columns: 1fr;
      }
      
      .step-progress-container {
        flex-wrap: wrap;
      }
      
      .step-text {
        min-width: auto;
        flex-basis: 100%;
        order: -1;
      }
    }
  </style>
</head>
<body>
  <div class="fr-skiplinks">
    <nav class="fr-container" role="navigation" aria-label="Acc√®s rapide">
      <ul class="fr-skiplinks__list">
        <li><a class="fr-link" href="#contenu">Contenu</a></li>
        <li><a class="fr-link" href="#footer">Pied de page</a></li>
      </ul>
    </nav>
  </div>
  
  <header role="banner" class="fr-header fr-no-print">
    <div class="fr-header__body">
      <div class="fr-container">
        <div class="fr-header__body-row">
          <div class="fr-header__brand fr-enlarge-link">
            <div class="fr-header__brand-top">
              <div class="fr-header__logo">
                <p class="fr-logo">R√©publique<br>fran√ßaise</p>
              </div>
            </div>
            <div class="fr-header__service">
              <a href="/" title="Accueil - Formulaire de satisfaction - R√©publique fran√ßaise">
                <p class="fr-header__service-title">D√©l√©gation √† la transformation num√©rique</p>
              </a>
              <p class="fr-header__service-tagline">Formulaire de satisfaction</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main id="contenu" role="main">
    <div class="fr-container fr-py-12v">
      <div class="fr-grid-row">
        <div class="fr-col-lg-10 fr-col-offset-lg-1">
          <h1 class="fr-h3 fr-mb-2w">Formulaire de satisfaction</h1>
          <p class="fr-text--sm fr-mb-4w fr-text-mention--grey">
            Votre avis nous permet d'am√©liorer le formulaire de satisfaction.
          </p>

          <!-- Introduction -->
          <div id="introSection">
            <div class="fr-callout fr-callout--blue-ecume fr-mb-4w">
              <p class="fr-callout__text">
                Ce formulaire de satisfaction est anonyme et prend environ 2 minutes √† compl√©ter.
                Vos r√©ponses nous aideront √† am√©liorer l'outil.
              </p>
            </div>

            <!-- Barre de progression -->
            <div id="progressCard" class="fr-card fr-mb-4w">
              <div class="fr-card__body">
                <div class="fr-card__content">
                  <div class="step-progress-container">
                    <span id="stepLabel" class="step-text">Question 1 sur 5</span>
                    <div class="step-progress-bar">
                      <div id="stepProgressFill" class="step-progress-fill" style="width: 20%"></div>
                    </div>
                    <span id="pctLabel" class="step-text">20%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Questions -->
          <div id="questionContainer"></div>

          <!-- Synth√®se -->
          <div id="synthesisContainer" class="hidden"></div>
        </div>
      </div>
    </div>
  </main>

  <footer class="fr-footer" role="contentinfo" id="footer">
    <div class="fr-container">
      <div class="fr-footer__body">
        <div class="fr-footer__brand fr-enlarge-link">
          <a href="/" title="Accueil - Formulaire de satisfaction - R√©publique fran√ßaise">
            <p class="fr-logo">R√©publique<br>fran√ßaise</p>
          </a>
        </div>
        <div class="fr-footer__content">
          <p class="fr-footer__content-desc">Formulaire de satisfaction</p>
          <ul class="fr-footer__content-list">
            <li class="fr-footer__content-item">
              <a class="fr-footer__content-link" target="_blank" rel="noopener external" 
                 title="info.gouv.fr - nouvelle fen√™tre" href="https://info.gouv.fr">info.gouv.fr</a>
            </li>
            <li class="fr-footer__content-item">
              <a class="fr-footer__content-link" target="_blank" rel="noopener external" 
                 title="service-public.fr - nouvelle fen√™tre" href="https://service-public.fr">service-public.fr</a>
            </li>
          </ul>
        </div>
      </div>
      <div class="fr-footer__bottom">
        <ul class="fr-footer__bottom-list">
          <li class="fr-footer__bottom-item">
            <a class="fr-footer__bottom-link" href="#" aria-label="Accessibilit√© : non conforme">Accessibilit√© : non conforme</a>
          </li>
          <li class="fr-footer__bottom-item">
            <a class="fr-footer__bottom-link" href="#">Mentions l√©gales</a>
          </li>
          <li class="fr-footer__bottom-item">
            <a class="fr-footer__bottom-link" href="#">Donn√©es personnelles</a>
          </li>
        </ul>
        <div class="fr-footer__bottom-copy">
          <p>Sauf mention explicite de propri√©t√© intellectuelle d√©tenue par des tiers, les contenus de ce site sont propos√©s sous 
             <a href="https://github.com/etalab/licence-ouverte/blob/master/LO.md" target="_blank" rel="noopener external" 
                title="Licence etalab - nouvelle fen√™tre">licence etalab-2.0</a>
          </p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Boutons secrets -->
  <button class="secret-view-link" id="secretViewBtn" type="button" title="Voir tous les retours">üìä</button>
  <button class="secret-reset-link" id="secretResetBtn" type="button" title="R√©initialisation">‚öôÔ∏è</button>

  <!-- Modal pour voir tous les retours -->
  <div id="viewModal" class="view-modal">
    <div class="view-modal-content">
      <div class="fr-grid-row fr-grid-row--middle fr-mb-4w">
        <div class="fr-col">
          <h3 class="fr-h4">Tous les retours</h3>
        </div>
        <div class="fr-col-auto">
          <button class="fr-btn fr-btn--secondary fr-btn--sm" id="viewModalClose" type="button">
            <span class="fr-icon-close-line" aria-hidden="true"></span>
            Fermer
          </button>
        </div>
      </div>
      <div id="allReturnsContent"></div>
    </div>
  </div>

  <!-- Modal de r√©initialisation -->
  <div id="resetModal" class="reset-modal">
    <div class="reset-modal-content">
      <h3 class="fr-h5 fr-mb-2w">R√©initialisation du formulaire</h3>
      <p class="fr-text--sm fr-mb-3w" style="color: #666;">Pour r√©initialiser toutes les donn√©es, veuillez entrer le code secret :</p>
      <div class="fr-input-group">
        <input 
          type="text" 
          id="resetCodeInput" 
          class="fr-input" 
          placeholder="Code secret"
          autocomplete="off">
        <div id="resetError" class="fr-error-text" style="display: none; margin-top: 8px;"></div>
        <div id="resetSuccess" class="fr-valid-text" style="display: none; margin-top: 8px;"></div>
      </div>
      <div class="fr-btns-group fr-btns-group--inline-md fr-btns-group--right fr-mt-3w">
        <button class="fr-btn fr-btn--secondary" id="resetCancel" type="button">Annuler</button>
        <button class="fr-btn" id="resetConfirm" type="button">R√©initialiser</button>
      </div>
    </div>
  </div>

  <!-- Scripts DSFR -->
  <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.2/dist/dsfr.module.min.js"></script>

  <script>
    // Questions de satisfaction
    const QUESTIONS = [
      {
        id: 1,
        question: "L'interface est-elle intuitive et ergonomique ?",
        type: "scale"
      },
      {
        id: 2,
        question: "Les questions sont-elles claires et pr√©cises ?",
        type: "scale"
      },
      {
        id: 3,
        question: "Le diagnostic est-il compr√©hensible et suffisamment complet ?",
        type: "scale"
      },
      {
        id: 4,
        question: "√ätes-vous globalement satisfait de ce formulaire de satisfaction ?",
        type: "scale"
      },
      {
        id: 5,
        question: "Avez-vous un retour √† nous faire ?",
        type: "textarea",
        placeholder: "Vos commentaires, suggestions, remarques...",
        optional: true
      }
    ];

    // √âchelle de satisfaction
    const SATISFACTION_SCALE = [
      { value: 5, label: "Tr√®s satisfait" },
      { value: 4, label: "Satisfait" },
      { value: 3, label: "Neutre" },
      { value: 2, label: "Insatisfait" },
      { value: 1, label: "Tr√®s insatisfait" }
    ];

    // √âtat de l'application
    let state = {
      current: 0,
      answers: {},
      comments: {}
    };

    // Charger l'√©tat sauvegard√©
    function loadState() {
      try {
        const saved = localStorage.getItem('satisfaction_state');
        if (saved) {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        }
      } catch (e) {
        console.warn('Erreur lors du chargement de l\'√©tat:', e);
      }
    }

    // Sauvegarder l'√©tat
    function saveState() {
      try {
        localStorage.setItem('satisfaction_state', JSON.stringify(state));
      } catch (e) {
        console.warn('Erreur lors de la sauvegarde:', e);
      }
    }

    // Sauvegarder une participation compl√®te (appel√©e m√™me si le formulaire n'est pas termin√©)
    function saveParticipation() {
      try {
        // Ne sauvegarder que si on a au moins une r√©ponse
        const hasAnswers = Object.keys(state.answers).length > 0 || Object.keys(state.comments).length > 0;
        if (!hasAnswers) return;
        
        const participation = {
          timestamp: new Date().toISOString(),
          answers: { ...state.answers },
          comments: { ...state.comments }
        };
        
        // R√©cup√©rer toutes les participations existantes
        let participations = [];
        const saved = localStorage.getItem('satisfaction_participations');
        if (saved) {
          participations = JSON.parse(saved);
        }
        
        // Ajouter la nouvelle participation
        participations.push(participation);
        
        // Sauvegarder
        localStorage.setItem('satisfaction_participations', JSON.stringify(participations));
      } catch (e) {
        console.warn('Erreur lors de la sauvegarde de la participation:', e);
      }
    }

    // Sauvegarder une participation uniquement quand on change de question ou termine
    let lastSavedState = null;
    function saveParticipationIfNeeded() {
      const currentState = JSON.stringify({ answers: state.answers, comments: state.comments });
      // Ne sauvegarder que si l'√©tat a vraiment chang√©
      if (currentState !== lastSavedState) {
        saveParticipation();
        lastSavedState = currentState;
      }
    }

    // R√©cup√©rer toutes les participations
    function getAllParticipations() {
      try {
        const saved = localStorage.getItem('satisfaction_participations');
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (e) {
        console.warn('Erreur lors du chargement des participations:', e);
      }
      return [];
    }

    // Initialiser
    loadState();
    renderStep();

    // Rendre une question
    function renderStep() {
      const questionContainer = document.getElementById('questionContainer');
      const introSection = document.getElementById('introSection');
      const synthesisContainer = document.getElementById('synthesisContainer');
      
      if (state.current >= QUESTIONS.length) {
        // Sauvegarder la participation compl√®te (une derni√®re fois pour √™tre s√ªr)
        saveParticipation();
        
        // Afficher la synth√®se
        introSection.classList.add('hidden');
        questionContainer.innerHTML = '';
        questionContainer.classList.add('hidden');
        synthesisContainer.classList.remove('hidden');
        renderSynthesis();
        return;
      }

      const q = QUESTIONS[state.current];
      const progress = ((state.current + 1) / QUESTIONS.length) * 100;
      
      // Mettre √† jour la progression
      document.getElementById('stepProgressFill').style.width = progress + '%';
      document.getElementById('stepLabel').textContent = `Question ${state.current + 1} sur ${QUESTIONS.length}`;
      document.getElementById('pctLabel').textContent = Math.round(progress) + '%';

      let questionHtml = '';

      if (q.type === 'scale') {
        // √âchelle de satisfaction
        const scaleHtml = SATISFACTION_SCALE.map(item => {
          const isSelected = state.answers[q.id] === item.value;
          return `
            <button 
              class="satisfaction-btn ${isSelected ? 'selected' : ''}" 
              data-value="${item.value}"
              data-question="${q.id}"
              type="button">
              <span class="satisfaction-emoji">${getEmoji(item.value)}</span>
              <span class="satisfaction-label">${item.label}</span>
            </button>
          `;
        }).join('');

        questionHtml = `
          <div class="fr-card fr-mb-4w">
            <div class="fr-card__body">
              <div class="fr-card__content">
                <h2 class="fr-h5 fr-mb-2w">${escapeHtml(q.question)}</h2>
                <div class="satisfaction-scale">
                  ${scaleHtml}
                </div>
                
                <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle fr-mt-4w fr-no-print">
                  <div class="fr-col-auto">
                    ${state.current > 0 ? '<button class="fr-btn fr-btn--tertiary-no-outline fr-icon-arrow-left-line fr-btn--icon-left" id="btn-prev" type="button">Pr√©c√©dent</button>' : ''}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (q.type === 'textarea') {
        // Champ texte libre
        questionHtml = `
          <div class="fr-card fr-mb-4w">
            <div class="fr-card__body">
              <div class="fr-card__content">
                <h2 class="fr-h5 fr-mb-2w">
                  ${escapeHtml(q.question)}
                  ${q.optional ? '<span class="fr-text--sm fr-text--disabled fr-ml-1v">(optionnel)</span>' : ''}
                </h2>
                
                <div class="fr-input-group fr-mb-4w">
                  <label class="fr-label" for="textarea-${q.id}">Votre r√©ponse</label>
                  <textarea 
                    class="fr-input" 
                    id="textarea-${q.id}" 
                    rows="8"
                    placeholder="${q.placeholder || ''}">${state.comments[q.id] || ''}</textarea>
                </div>
                
                <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle fr-mt-4w fr-no-print">
                  <div class="fr-col-auto">
                    ${state.current > 0 ? '<button class="fr-btn fr-btn--tertiary-no-outline fr-icon-arrow-left-line fr-btn--icon-left" id="btn-prev" type="button">Pr√©c√©dent</button>' : ''}
                  </div>
                  <div class="fr-col"></div>
                  <div class="fr-col-auto">
                    <button class="fr-btn" id="btn-finish" type="button">
                      Terminer
                      <span class="fr-icon-check-line fr-mr-1v" aria-hidden="true"></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      questionContainer.innerHTML = questionHtml;

      // Event listeners pour les boutons de satisfaction
      if (q.type === 'scale') {
        questionContainer.querySelectorAll('.satisfaction-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const value = parseInt(this.dataset.value);
            const questionId = parseInt(this.dataset.question);
            
            // D√©s√©lectionner les autres boutons
            questionContainer.querySelectorAll('.satisfaction-btn').forEach(b => {
              b.classList.remove('selected');
            });
            
            // S√©lectionner le bouton cliqu√©
            this.classList.add('selected');
            
            // Enregistrer la r√©ponse
            state.answers[questionId] = value;
            saveState();
            
            // Passer automatiquement √† la question suivante apr√®s un court d√©lai
            setTimeout(() => {
              nextStep(); // nextStep() sauvegarde d√©j√† la participation
            }, 300);
          });
        });
      }

      // Event listeners pour le textarea
      if (q.type === 'textarea') {
        const textarea = document.getElementById(`textarea-${q.id}`);
        if (textarea) {
          textarea.addEventListener('input', function() {
            state.comments[q.id] = this.value;
            saveState();
          });
        }
        
        // Event listener pour le bouton Terminer
        document.getElementById('btn-finish')?.addEventListener('click', () => {
          saveParticipationIfNeeded(); // Sauvegarder avant de terminer
          nextStep();
        });
      }

      // Event listener pour le bouton pr√©c√©dent
      document.getElementById('btn-prev')?.addEventListener('click', () => {
        prevStep();
      });

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function getEmoji(value) {
      const emojis = {
        5: 'üòä',
        4: 'üôÇ',
        3: 'üòê',
        2: 'üòï',
        1: 'üòû'
      };
      return emojis[value] || 'üòê';
    }

    function nextStep() {
      // Sauvegarder la participation avant de passer √† la question suivante
      saveParticipationIfNeeded();
      state.current++;
      saveState();
      renderStep();
    }

    function prevStep() {
      state.current = Math.max(0, state.current - 1);
      saveState();
      renderStep();
    }

    function escapeHtml(str) {
      return (str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Formater une date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Rendre la synth√®se
    function renderSynthesis() {
      const synthesisContainer = document.getElementById('synthesisContainer');
      
      // Calculer les statistiques de la session actuelle
      const scaleAnswers = [];
      for (let i = 1; i <= 4; i++) {
        if (state.answers[i]) {
          scaleAnswers.push(state.answers[i]);
        }
      }
      
      const currentAverage = scaleAnswers.length > 0 
        ? (scaleAnswers.reduce((a, b) => a + b, 0) / scaleAnswers.length).toFixed(1)
        : 0;
      
      // R√©cup√©rer toutes les participations
      const allParticipations = getAllParticipations();
      
      // Calculer les statistiques globales
      let globalScores = [];
      allParticipations.forEach(part => {
        const partScores = [];
        for (let i = 1; i <= 4; i++) {
          if (part.answers[i]) {
            partScores.push(part.answers[i]);
          }
        }
        if (partScores.length > 0) {
          const avg = partScores.reduce((a, b) => a + b, 0) / partScores.length;
          globalScores.push(avg);
        }
      });
      
      const globalAverage = globalScores.length > 0
        ? (globalScores.reduce((a, b) => a + b, 0) / globalScores.length).toFixed(1)
        : 0;
      
      const maxSatisfaction = scaleAnswers.filter(a => a >= 4).length;
      const minSatisfaction = scaleAnswers.filter(a => a <= 2).length;
      
      // Traduire les valeurs en texte
      function getSatisfactionLabel(value) {
        const item = SATISFACTION_SCALE.find(s => s.value === value);
        return item ? item.label : 'Non renseign√©';
      }
      
      let resultsHtml = QUESTIONS.slice(0, 4).map(q => {
        const value = state.answers[q.id];
        const label = value ? getSatisfactionLabel(value) : 'Non renseign√©';
        const emoji = value ? getEmoji(value) : '';
        
        return `
          <div class="fr-col-12 fr-col-md-6 fr-mb-3w">
            <div class="fr-card">
              <div class="fr-card__body">
                <div class="fr-card__content">
                  <h3 class="fr-card__title fr-h6 fr-mb-2w">${escapeHtml(q.question)}</h3>
                  <div style="display: flex; align-items: center; gap: 0.75rem;">
                    ${emoji ? `<span style="font-size: 2rem; line-height: 1;">${emoji}</span>` : ''}
                    <div>
                      <p class="fr-text--lg fr-mb-0">
                        <strong>${label}</strong>
                        ${value ? `<span class="fr-text--sm fr-text--disabled fr-ml-2v">(${value}/5)</span>` : ''}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Commentaire libre
      let commentHtml = '';
      if (state.comments[5]) {
        commentHtml = `
          <div class="fr-col-12">
            <div class="fr-card fr-mt-4w">
              <div class="fr-card__body">
                <div class="fr-card__content">
                  <h3 class="fr-card__title fr-h6 fr-mb-2w">Votre retour</h3>
                  <div class="fr-callout fr-mt-2w">
                    <p class="fr-text--sm fr-mb-0" style="white-space: pre-wrap; line-height: 1.6;">${escapeHtml(state.comments[5])}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      synthesisContainer.innerHTML = `
        <div class="fr-mb-6w">
          <h2 class="fr-h4 fr-mb-2w">Synth√®se de votre satisfaction</h2>
          <div class="fr-callout fr-callout--blue-ecume">
            <p class="fr-callout__text fr-mb-0">
              Merci d'avoir pris le temps de r√©pondre √† ce formulaire de satisfaction.
              Vos r√©ponses nous aideront √† am√©liorer l'outil.
            </p>
          </div>
        </div>
        
        <div class="synthesis-stats">
          <div class="fr-card">
            <div class="fr-card__body">
              <div class="fr-card__content" style="text-align: center;">
                <h3 class="fr-h2" style="color: #000091; margin-bottom: 0.5rem;">${currentAverage}</h3>
                <p class="fr-text--sm" style="color: #666;">Score actuel / 5</p>
              </div>
            </div>
          </div>
          <div class="fr-card">
            <div class="fr-card__body">
              <div class="fr-card__content" style="text-align: center;">
                <h3 class="fr-h2" style="color: #000091; margin-bottom: 0.5rem;">${globalAverage}</h3>
                <p class="fr-text--sm" style="color: #666;">Score moyen global<br>/ 5</p>
              </div>
            </div>
          </div>
          <div class="fr-card">
            <div class="fr-card__body">
              <div class="fr-card__content" style="text-align: center;">
                <h3 class="fr-h2" style="color: #000091; margin-bottom: 0.5rem;">${allParticipations.length}</h3>
                <p class="fr-text--sm" style="color: #666;">Nombre de participations</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="fr-mt-6w">
          <h3 class="fr-h5 fr-mb-3w">D√©tail de vos r√©ponses</h3>
          <div class="fr-grid-row fr-grid-row--gutters">
            ${resultsHtml}
          </div>
        </div>
        
        ${commentHtml ? `
          <div class="fr-mt-6w">
            <h3 class="fr-h5 fr-mb-3w">Vos commentaires</h3>
            <div class="fr-grid-row fr-grid-row--gutters">
              ${commentHtml}
            </div>
          </div>
        ` : ''}
      `;
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Code secret pour r√©initialisation
    const RESET_SECRET_CODE = 'DTNumRAZ';

    // Fonction pour afficher le modal de r√©initialisation
    function showResetModal() {
      const modal = document.getElementById('resetModal');
      const input = document.getElementById('resetCodeInput');
      const errorDiv = document.getElementById('resetError');
      const successDiv = document.getElementById('resetSuccess');
      
      modal.classList.add('show');
      input.value = '';
      input.focus();
      if (errorDiv) {
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
      }
      if (successDiv) {
        successDiv.style.display = 'none';
        successDiv.textContent = '';
      }
    }

    // Fonction pour cacher le modal de r√©initialisation
    function hideResetModal() {
      const modal = document.getElementById('resetModal');
      modal.classList.remove('show');
    }

    // Fonction pour r√©initialiser toutes les donn√©es
    function performReset() {
      state.current = 0;
      state.answers = {};
      state.comments = {};
      try {
        localStorage.removeItem('satisfaction_state');
        localStorage.removeItem('satisfaction_participations');
      } catch (e) {
        console.warn('Erreur lors de la suppression:', e);
      }
      
      const introSection = document.getElementById('introSection');
      const questionContainer = document.getElementById('questionContainer');
      const synthesisContainer = document.getElementById('synthesisContainer');
      
      introSection.classList.remove('hidden');
      questionContainer.classList.remove('hidden');
      synthesisContainer.classList.add('hidden');
      
      hideResetModal();
      renderStep();
      
      // Afficher un message de succ√®s
      const successDiv = document.getElementById('resetSuccess');
      if (successDiv) {
        successDiv.textContent = '‚úÖ Formulaire r√©initialis√© avec succ√®s !';
        successDiv.style.display = 'block';
      }
      
      setTimeout(() => {
        hideResetModal();
      }, 1500);
    }

    // Fonction pour afficher tous les retours
    function showAllReturns() {
      const modal = document.getElementById('viewModal');
      const content = document.getElementById('allReturnsContent');
      const allParticipations = getAllParticipations();
      
      if (allParticipations.length === 0) {
        content.innerHTML = `
          <div class="fr-callout fr-callout--info">
            <p class="fr-callout__text">Aucun retour n'a encore √©t√© enregistr√©.</p>
          </div>
        `;
      } else {
        let returnsHtml = allParticipations.map((part, index) => {
          // Calculer le score moyen pour cette participation
          const partScores = [];
          for (let i = 1; i <= 4; i++) {
            if (part.answers[i]) {
              partScores.push(part.answers[i]);
            }
          }
          const partAvg = partScores.length > 0
            ? (partScores.reduce((a, b) => a + b, 0) / partScores.length).toFixed(1)
            : 0;
          
          // Fonction pour obtenir le label de satisfaction
          function getSatisfactionLabel(value) {
            const item = SATISFACTION_SCALE.find(s => s.value === value);
            return item ? item.label : 'Non renseign√©';
          }
          
          // G√©n√©rer les r√©ponses aux questions
          let answersHtml = QUESTIONS.slice(0, 4).map(q => {
            const value = part.answers[q.id];
            if (!value) return '';
            const label = getSatisfactionLabel(value);
            const emoji = getEmoji(value);
            
            return `
              <div class="return-question-item">
                <div class="return-question-text">${escapeHtml(q.question)}</div>
                <div class="return-answer">
                  ${emoji ? `<span style="font-size: 1.5rem;">${emoji}</span>` : ''}
                  <span><strong>${label}</strong> <span class="fr-text--sm fr-text--disabled">(${value}/5)</span></span>
                </div>
              </div>
            `;
          }).join('');
          
          // Commentaire s'il existe
          let commentHtml = '';
          if (part.comments && part.comments[5] && part.comments[5].trim()) {
            commentHtml = `
              <div class="return-comment">
                <strong>Commentaire :</strong><br>
                ${escapeHtml(part.comments[5])}
              </div>
            `;
          }
          
          return `
            <div class="return-item">
              <div class="return-header">
                <div>
                  <div class="return-date">
                    <strong>Retour ${allParticipations.length - index}</strong> ‚Äî ${formatDate(part.timestamp)}
                  </div>
                </div>
                <div class="return-score">Score : ${partAvg}/5</div>
              </div>
              ${answersHtml}
              ${commentHtml}
            </div>
          `;
        }).reverse().join('');
        
        content.innerHTML = `
          <div class="fr-callout fr-callout--blue-ecume fr-mb-4w">
            <p class="fr-callout__text fr-mb-0">
              <strong>${allParticipations.length}</strong> retour${allParticipations.length > 1 ? 's' : ''} enregistr√©${allParticipations.length > 1 ? 's' : ''}
            </p>
          </div>
          ${returnsHtml}
        `;
      }
      
      modal.classList.add('show');
    }

    // Fonction pour cacher le modal des retours
    function hideAllReturns() {
      const modal = document.getElementById('viewModal');
      modal.classList.remove('show');
    }

    // Event listeners pour le modal de consultation des retours
    document.getElementById('secretViewBtn')?.addEventListener('click', () => {
      showAllReturns();
    });

    document.getElementById('viewModalClose')?.addEventListener('click', () => {
      hideAllReturns();
    });

    // Fermer le modal en cliquant en dehors
    document.getElementById('viewModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'viewModal') {
        hideAllReturns();
      }
    });

    // Event listeners pour le modal de r√©initialisation
    document.getElementById('secretResetBtn')?.addEventListener('click', () => {
      showResetModal();
    });

    document.getElementById('resetCancel')?.addEventListener('click', () => {
      hideResetModal();
    });

    document.getElementById('resetConfirm')?.addEventListener('click', () => {
      const input = document.getElementById('resetCodeInput');
      const code = input.value.trim();
      const errorDiv = document.getElementById('resetError');
      const successDiv = document.getElementById('resetSuccess');
      
      // Masquer les messages pr√©c√©dents
      if (errorDiv) errorDiv.style.display = 'none';
      if (successDiv) successDiv.style.display = 'none';
      
      if (code === RESET_SECRET_CODE) {
        // Code correct
        performReset();
      } else {
        // Code incorrect
        if (errorDiv) {
          errorDiv.textContent = '‚ùå Code secret incorrect. Veuillez r√©essayer.';
          errorDiv.style.display = 'block';
        }
        input.value = '';
        input.focus();
      }
    });

    // Permettre la validation avec Enter dans le champ de code
    document.getElementById('resetCodeInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('resetConfirm')?.click();
      }
    });

    // Fermer le modal en cliquant en dehors
    document.getElementById('resetModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'resetModal') {
        hideResetModal();
      }
    });

    // Initialiser DSFR
    if (window.dsfr) {
      window.dsfr.start();
    }
  </script>
</body>
</html>
